---
title: "05_Biodiversity"
output: html_document
date: "2025-04-11"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.path = "../figures/05_Biodiversity/")
```
# Set up the Environment 

## Question & Hypotheses

Are the microbial biodiversities on burn wounds and on corresponding spared skin significantly different?

- *Null Hypothesis:* Microbial biodiversity is the same on burned and spared skin.
- *Alternative Hypothesis:* Microbial biodiversity is lower at burn wounds compared to spared skin.

## Timing of this script

```{r rmd-start}
# What time did we start running this script? 
start_time <- Sys.time()
```

## Set the seed 
```{r set-seed}
set.seed(238428)
```

## Load Packages & Colors 

```{r load-packages-colors}
#install packages for stats
#install.packages("rstatix")
#install.packages("ggpubr")

pacman::p_load(tidyverse, devtools, patchwork, iNEXT, phyloseq,
               # packages for stats
               ggpubr, rstatix, install = FALSE)

# Load in colors for plotting 
source("code/colors.R")
```

## Load in Data 

```{r load-data}
load("data/04_PhylogeneticTree/phytree_preprocessed_physeqs.RData")

# take a look at it! 
midpoint_rooted_physeq

# Intuition check on seq depth
min(sample_sums(midpoint_rooted_physeq))

# Make a metadata dataframe 
metadata_df <- 
  midpoint_rooted_physeq %>%
  sample_data() %>%
  data.frame()

# view of it
glimpse(metadata_df)
```


# Biodiversity Hill Numbers with iNEXT


```{r iNEXT-biodiversity}
# prepare the input data 
# Species in rows and the samples in columns 
iNEXT_input_df <- 
  midpoint_rooted_physeq %>%
  otu_table() %>%
  data.frame()

# Inpect 
dim(iNEXT_input_df)
iNEXT_input_df[1:5, 1:5]

# Run iNEXT 
# Remember to set the seed!
# ASVs in ROWs, samples in COLUMNS 
iNEXT_data <- iNEXT(iNEXT_input_df, 
                  q = c(0, 1, 2),
                    datatype = "abundance")

# Inspect 
str(iNEXT_data)
typeof(iNEXT_data)
```

```{r save-inext}
save(iNEXT_data, 
     file = "data/05_Biodiversity/iNEXT_data.RData")
```

# Rarefaction Curves 

## `ggiNEXT` Rarefaction Curves 

```{r iNEXT-colors}
# Prepare Colors 
color_df <- 
  iNEXT_input_df %>%
  colnames() %>%
  data.frame()
# Check
head(color_df)
# Rename the column 
colnames(color_df)[1] <- "names"
# Check
head(color_df)

colnames(metadata_df)[1] <- "Run"
head(metadata_df)

# Make a helper dataframe for plotting with colors 
iNEXT_color_df <- 
  color_df %>%
  # Fix the names for merging
  #mutate(names = gsub(names, pattern = "[.]", replace = "-"),
  #       names = gsub(names, pattern = "X",  replace = "")) %>%
  # Merge with metadata
  left_join(metadata_df, by = "names") %>%
  # Merge with colors for plotting with ggiNEXT
  left_join(data.frame(type_colors = colors,
            env_local_scale = names(colors)),
            by = "env_local_scale")

head(iNEXT_color_df)
```

```{r plot-iNEXT-rarefaction}
ggiNEXT(iNEXT_data, type = 1, facet.var = "Order.q") + 
  scale_color_manual(values = iNEXT_color_df$type_colors) + 
  scale_fill_manual(values = iNEXT_color_df$type_colors) + 
  scale_shape_manual(values = base::rep(17, nsamples(midpoint_rooted_physeq))) + 
  theme_bw() + 
  theme(legend.position = "none") + 
  labs(y = "Effective Number of ASVs", x = "Number of Sequences") 
```

Remembering that an Order q of:  

  - 0 = Richness/ Number of Total taxa
  - 1 = Exponential Shannon / Number of "Common" taxa
  - 2 = Inverse Simpson / Number of "Dominant" taxa 
  
## Manual Rarefaction Curves 

```{r manual-rarefaction}
str(iNEXT_data)

iNEXT_manual_df <- 
  iNEXT_data$iNextEst$size_based %>%
  dplyr::rename(names = Assemblage) %>%
  # fix the samples to merge with metadata 
  #mutate(names = gsub(names, pattern = "[.]", replace = "-"),
  #       names = gsub(names, pattern = "X", replace = "")) %>%
  # join with the metadata
  left_join(., metadata_df, by = "names") %>%
  mutate(station = factor(env_local_scale, levels = c("burn",
                                              "spared",
                                              "rectal",
                                              "perianal"
                                                )))

# Inspection
dim(iNEXT_manual_df)

# Manually plot rarefaction curves 
iNEXT_manual_df %>%
  # Filter out rows that are calculated with actual sequences (no extrapolated)
  dplyr::filter(Method == "Rarefaction") %>%
  # Now, let's draw the plot! 
  ggplot(aes(x = m, y = qD, color = env_local_scale, group = names)) + 
  geom_line() + 
  # Facet by station 
  facet_grid(Order.q~env_local_scale, scales = "free") + 
  scale_color_manual(values = colors) + 
  theme_bw() + 
  labs(y = "Effective Number of ASVs", x = "Number of Sequences") + 
  theme(legend.position = "bottom")
```

<span style="color: red;">INTERPRETATION #1:  What can you conclude from the ggiNEXT and manual rarefaction curve plots? Are there "enough" sequences to analyze the samples? Is it valid to make any conclusions about species richness when q = 0? What about when q = 1? Or q = 2? Why or why not?</span>

The variation is pretty big, especially for perianal q=1/2 and rectal q=2. Outliers are found in spared q=0 and burn q=1/2. Overall there doesnt seem to be much different among the different types of samples. Rectal and perianal seem to have slightly higher Shannon and Simpson diversity then cutaneous samples. Burn samples seem to have the lowest alpha diversity for all three measures. 
It looks like there are enough sequences. Most samples flattened to very straight lines.The strongest conclusions can be made from q=2, as the lines extended to completely horizontal. conslusions for q=0 might be weaker compared to the other two.

# Statististical Testing 

```{r shapiro-wilk-richness}
### Now what about for richness? 
obs_div_df <- 
  iNEXT_manual_df %>%
  dplyr::filter(Method == "Observed") 

# check it
glimpse(obs_div_df)

# Pull out unique data from the three fractions of samples 
obs_whole_rich_df <- 
  obs_div_df %>%
  dplyr::filter(fraction == "Whole") %>%
  dplyr::filter(Order.q == 0)

# Test of the data is normal for the continuous value of richness
shapiro.test(obs_whole_rich_df$qD)
```

# Categorical Analysis: 2 or more groups 

```{r make-obs-df}

obs_div_df <- 
  iNEXT_manual_df %>%
  dplyr::filter(Method == "Observed") 

# Plot boxplots by station against diversity
obs_div_df %>%
  ggplot(aes(x = env_local_scale, y = qD, fill = env_local_scale, 
             color = env_local_scale)) + 
  facet_wrap(.~Order.q, scales = "free_y") + 
  geom_jitter() + 
  geom_boxplot(alpha = 0.5, outlier.shape = NA) + 
  scale_color_manual(values = colors) + 
  scale_fill_manual(values = colors) + 
  labs(y = "Effective Number of ASVs") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   hjust = 1, 
                                   vjust = 1))
```


#### Statistically test Richness


```{r station-diversity-richness, fig.height=4, fig.width=4}
# Pull out richness data 
obs_rich_df <- 
  obs_div_df %>%
  dplyr::filter(Order.q == 0)

# Calculate the ANOVA since the data is normal. :) 
anova_station_rich <- 
  aov(qD ~ env_local_scale, data = obs_rich_df)

# Look at it 
anova_station_rich
summary(anova_station_rich)

# Richness by station 
rich_ggboxplot <- 
  ggboxplot(obs_rich_df, x = "env_local_scale", y = "qD", 
          color = "env_local_scale", fill = "env_local_scale", alpha = 0.3,
          outlier.shape = NA) + 
  # Add points
  geom_jitter(aes(color = env_local_scale)) + 
  scale_color_manual(values = colors) + 
  scale_fill_manual(values = colors) + 
  labs(y = "# of Total ASVs (Richness)") + 
  # Add ANOVA & Tukey
  stat_compare_means(method = "anova", label.y = min(obs_rich_df$qD)) +  # ANOVA p-value
  geom_pwc(
    aes(group = env_local_scale), tip.length = 0, hide.ns = TRUE,
    method = "t_test", label = "p.adj.format",
    p.adjust.method = "fdr", bracket.nudge.y = -0.08) + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   hjust = 1, 
                                   vjust = 1))

rich_ggboxplot
```

### Simpson

```{r station-diversity-simpson, fig.height=4, fig.width=4}
# Pull out simpson data 
obs_simps_df <- 
  obs_div_df %>%
  dplyr::filter(Order.q == 2)

# Calculate the ANOVA since the data is normal. :) 
anova_station_simps <- 
  aov(qD ~ station, data = obs_simps_df)

# Look at it 
anova_station_simps
summary(anova_station_simps)

# Simpson by station 
simps_ggboxplot <- 
  ggboxplot(obs_simps_df, x = "env_local_scale", y = "qD", 
          color = "env_local_scale", fill = "env_local_scale", alpha = 0.3,
          outlier.shape = NA) + 
  # Add points
  geom_jitter(aes(color = env_local_scale)) + 
  scale_color_manual(values = colors) + 
  scale_fill_manual(values = colors) + 
  labs(y = "# of Dominant ASVs (Simpson)") +
  # Add ANOVA & Tukey
  stat_compare_means(method = "anova", label.y = 80) +  # ANOVA p-value
  geom_pwc(
    aes(group = env_local_scale), tip.length = 0, hide.ns = TRUE,
    method = "t_test", label = "p.adj.signif",
    step.increase = 0.08,
    p.adjust.method = "fdr", bracket.nudge.y = -0.08) + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   hjust = 1, 
                                   vjust = 1))
```

```{r plot-rich-simps, fig.width=8, fig.height=4}
# Show the plots
rich_ggboxplot + simps_ggboxplot
```

<span style="color: red;">INTERPRETATION #2:  If you have categorical data, what can you conclude regarding the role that all ASVs (richess, q = 0) versus common ASVs (Shannon, q = 1) versus dominant ASVs (Simpson, q = 2) have on the biodiversity of your samples as it relates to your variable of interest?</span>


The difference between alpha diversity gets more exaggerated when abundance is weighed more. The perianal and rectal diversities are more significantly higher than cutaneous samples in Simpson and Shannon analysis compared to sole richness.

<span style="color: red;">INTERPRETATION #3:  How did you statistically test your scientific question in Interpretation #2? Why?</span>

I tested the difference in Simpson diveristy across tissue samples using ANOVA. It can be used because the data is normal
# Final info for Reproducibility 

## Check Render Time
```{r stop-time}
# Take the time now that we are at the end of the script
end_time <- Sys.time()
end_time 

# Echo the elapsed time
elapsed_time <- round((end_time - start_time), 3)
elapsed_time
```

## Session Information

```{r session-info}
# Ensure reproducibility with package version information
devtools::session_info()
```
